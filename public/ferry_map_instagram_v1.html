<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8">
  <title>전남 여객선 지도 (Instagram Style)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">

  <style>
    :root {
      --sheet-bg: #ffffff;
      --accent: #22c55e;
      --text-muted: #6b7280;
      --border-subtle: #e5e7eb;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, "Apple SD Gothic Neo", system-ui, sans-serif;
      background: #f3f4f6;
      overscroll-behavior: none;
    }

    /* ===== 헤더 (상단바) ===== */
    header {
      position: fixed;
      top: 0; left: 0; right: 0;
      z-index: 20;
      background: #ffffffee;
      backdrop-filter: blur(12px);
      padding: 12px 16px;
      display: flex;
      align-items: center;
      gap: 8px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.06);
    }

    header strong {
      font-size: 18px;
      font-weight: 700;
      white-space: nowrap;
    }

    header select,
    header button {
      padding: 12px 18px;
      border-radius: 14px;
      font-size: 15px;
      font-weight: 600;
      border: none;
      background: #f7f7f7;
      box-shadow: 0 2px 4px rgba(0,0,0,0.06);
      min-height: 42px;
      cursor: pointer;
      white-space: nowrap;
    }

    header select:focus,
    header button:active {
      outline: none;
      background: #efefef;
      box-shadow: 0 3px 8px rgba(0,0,0,0.12);
    }

    #map {
      position: absolute;
      top: 52px; /* header height */
      left: 0;
      right: 0;
      bottom: 0;
    }

    /* ===== Bottom Sheet ===== */
    .bottom-sheet {
      position: fixed;
      left: 0;
      right: 0;
      bottom: 0;
      z-index: 30;
      background: var(--sheet-bg);
      border-radius: 22px 22px 0 0;
      box-shadow: 0 -6px 20px rgba(0,0,0,0.08);
      transform: translateY(70%);
      transition: transform 0.25s ease-out;
      max-height: 80vh;
      display: flex;
      flex-direction: column;
    }

    .bottom-sheet.expanded {
      transform: translateY(0);
    }

    .sheet-handle {
      width: 100%;
      padding-top: 8px;
      padding-bottom: 6px;
      display: flex;
      justify-content: center;
      align-items: center;
      cursor: pointer;
    }

    .sheet-handle-bar {
      width: 48px;
      height: 6px;
      border-radius: 999px;
      background: #d4d4d4;
    }

    .sheet-header {
      padding: 4px 18px 10px 18px;
      border-bottom: 1px solid var(--border-subtle);
    }

    .sheet-title {
      font-size: 19px;
      font-weight: 700;
    }

    .sheet-subtitle {
      font-size: 15px;
      color: #737373;
      margin-top: 4px;
    }

    .sheet-content {
      padding: 10px 18px 14px 18px;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
    }

    /* ===== 칩(Chip) ===== */
    .chip-row {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-bottom: 10px;
    }

    .chip {
      font-size: 13px;
      padding: 6px 12px;
      border-radius: 20px;
      background: #f3f3f3;
      border: none;
      font-weight: 600;
      color: #4b5563;
    }

    /* ===== 섹션 공통 ===== */
    .section {
      margin-bottom: 20px;
    }

    .section-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 8px;
    }

    .section-title {
      font-size: 17px;
      font-weight: 700;
    }

    .section-sub {
      font-size: 13px;
      color: #9ca3af;
    }

    .empty {
      font-size: 14px;
      color: var(--text-muted);
      padding: 8px 0;
    }

    /* ===== 터미널 기본 정보 ===== */
    #terminalInfo {
      font-size: 14px;
      color: #4b5563;
    }

    /* ===== 시간표 카드 ===== */
    .timetable-item {
      background: #ffffff;
      border-radius: 16px;
      padding: 12px 14px;
      margin-bottom: 10px;
      box-shadow: 0 3px 8px rgba(0,0,0,0.05);
      font-size: 15px;
    }

    .timetable-top {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 6px;
    }

    .time-main {
      font-size: 16px;
      font-weight: 700;
    }

    .time-sub {
      font-size: 13px;
      color: #6b7280;
    }

    .notes {
      font-size: 12px;
      color: var(--text-muted);
      margin-top: 4px;
    }

    .badge {
      display: inline-block;
      padding: 3px 8px;
      border-radius: 999px;
      font-size: 12px;
      border: 1px solid #d4d4d8;
      color: #4b5563;
      background: #f9fafb;
      white-space: nowrap;
    }

    .badge-status-출항 {
      border-color: #22c55e;
      color: #16a34a;
      background: #ecfdf3;
    }

    .badge-status-결항 {
      border-color: #ef4444;
      color: #b91c1c;
      background: #fef2f2;
    }

    .badge-status-지연 {
      border-color: #f97316;
      color: #c2410c;
      background: #fff7ed;
    }

    .badge-status-대기 {
      border-color: #3b82f6;
      color: #1d4ed8;
      background: #eff6ff;
    }

    /* ===== 탭 바 ===== */
    .tab-bar {
      display: flex;
      gap: 6px;
      padding: 4px;
      border-radius: 999px;
      background: #f3f4f6;
      margin-bottom: 10px;
      margin-top: 4px;
    }

    .tab-btn {
      flex: 1;
      border: none;
      border-radius: 999px;
      padding: 6px 0;
      font-size: 14px;
      font-weight: 600;
      background: transparent;
      color: #6b7280;
      cursor: pointer;
    }

    .tab-btn.active {
      background: #111827;
      color: #ffffff;
      box-shadow: 0 2px 6px rgba(0,0,0,0.15);
    }

    .tab-content {
      display: block;
    }

    /* ===== 운임표 리스트 ===== */
    .fare-list {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .fare-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
      background: #ffffff;
      border-radius: 14px;
      padding: 8px 10px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.04);
      font-size: 14px;
    }

    .fare-main {
      flex: 1;
    }

    .fare-title {
      font-weight: 600;
    }

    .fare-sub {
      font-size: 12px;
      color: #6b7280;
      margin-top: 2px;
    }

    .fare-amount {
      font-weight: 700;
      white-space: nowrap;
    }

    /* ===== 주변 장소 카드 (인스타 스타일) ===== */
    .place-row {
      display: flex;
      gap: 10px;
      overflow-x: auto;
      padding-bottom: 4px;
      -webkit-overflow-scrolling: touch;
    }

    .place-card {
      flex: 0 0 160px;
      background: #ffffff;
      border-radius: 18px;
      padding: 10px;
      border: none;
      box-shadow: 0 4px 10px rgba(0,0,0,0.06);
      cursor: pointer;
      display: flex;
      flex-direction: column;
      gap: 6px;
      transition: transform 0.15s ease, box-shadow 0.15s ease;
    }

    .place-card:hover {
      transform: translateY(-3px);
      box-shadow: 0 6px 14px rgba(0,0,0,0.1);
    }

    .place-thumb {
      width: 100%;
      height: 96px;
      border-radius: 16px;
      background: linear-gradient(135deg, #e2e2e2, #efefef);
      position: relative;
      overflow: hidden;
    }

    .place-thumb::after {
      content: "PHOTO";
      position: absolute;
      bottom: 6px;
      right: 8px;
      font-size: 10px;
      color: rgba(255,255,255,0.9);
      padding: 2px 6px;
      border-radius: 999px;
      background: rgba(0,0,0,0.35);
    }

    .place-name {
      font-size: 14px;
      font-weight: 700;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .place-meta {
      font-size: 12px;
      color: var(--text-muted);
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .place-tag {
      font-size: 11px;
      display: inline-block;
      padding: 2px 6px;
      border-radius: 999px;
      border: 1px solid #e5e7eb;
      color: #4b5563;
      background: #ffffff;
      margin-top: 2px;
    }

    @media (min-width: 768px) {
      .bottom-sheet {
        left: 50%;
        transform: translate(50%, 60%);
        max-width: 420px;
        border-radius: 22px;
      }
      .bottom-sheet.expanded {
        transform: translate(50%, 0);
      }
    }

    /* 모바일 폰트 강화 — 480px 이하 해상도에 적용 */
    @media (max-width: 480px) {
      body { font-size: 19px; }
      header strong { font-size: 22px; }
      header select,
      header button {
        font-size: 19px;
        padding: 14px 20px;
      }
      .sheet-title { font-size: 24px; }
      .sheet-subtitle { font-size: 19px; }
      .chip { font-size: 17px; padding: 8px 14px; }
      .section-title { font-size: 19px; }
      .section-sub { font-size: 17px; }
      #terminalInfo { font-size: 18px; }
      .timetable-item { font-size: 19px; padding: 16px; }
      .time-main { font-size: 19px; }
      .time-sub { font-size: 15px; }
      .notes { font-size: 14px; }
      .place-name { font-size: 16px; }
      .place-meta { font-size: 14px; }
      .place-tag { font-size: 13px; }
      .empty { font-size: 16px; }
    }
  </style>

  <!-- Kakao 지도 + Places 라이브러리 -->
  <script src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=257fdd3647dd6abdb05eae8681106514&libraries=services"></script>
</head>
<body>
<header>
  <strong>전남 여객선</strong>
  <select id="terminalSelect">
    <option value="">터미널 선택</option>
  </select>
  <button id="locBtn">내 위치</button>
</header>

<div id="map"></div>

<!-- Bottom Sheet -->
<div id="bottomSheet" class="bottom-sheet">
  <div class="sheet-handle" id="sheetToggle">
    <div class="sheet-handle-bar"></div>
  </div>
  <div class="sheet-header">
    <div class="sheet-title" id="sheetTitle">터미널을 선택하세요</div>
    <div class="sheet-subtitle" id="sheetSubtitle">지도에서 핀을 누르거나 상단 셀렉트 박스를 선택하세요.</div>
  </div>
  <div class="sheet-content">
    <!-- 터미널 태그 / 기본 정보 -->
    <div class="chip-row" id="chipRow" style="display:none;"></div>
    <div class="section" id="terminalInfo" style="display:none;"></div>

    <!-- 운임/시간표 탭 -->
    <div class="tab-bar">
      <button class="tab-btn active" data-tab="timetable">시간표</button>
      <button class="tab-btn" data-tab="passenger">승객요금</button>
      <button class="tab-btn" data-tab="vehicle">차량운임</button>
    </div>

    <!-- 시간표 탭 -->
    <div class="section tab-content" id="tab-timetable">
      <div class="section-header">
        <div class="section-title">오늘 시간표 & 실시간 운항</div>
        <div class="section-sub" id="timetableSummary"></div>
      </div>
      <div id="timetableList" class="timetable-list">
        <div class="empty">표시할 운항 정보가 없습니다.</div>
      </div>
    </div>

    <!-- 승객 요금 탭 -->
    <div class="section tab-content" id="tab-passenger" style="display:none;">
      <div class="section-header">
        <div class="section-title">승객 요금</div>
        <div class="section-sub" id="passengerSummary"></div>
      </div>
      <div id="passengerFareList" class="fare-list">
        <div class="empty">승객 요금 정보가 없습니다.</div>
      </div>
    </div>

    <!-- 차량 운임 탭 -->
    <div class="section tab-content" id="tab-vehicle" style="display:none;">
      <div class="section-header">
        <div class="section-title">차량 운임</div>
        <div class="section-sub" id="vehicleSummary"></div>
      </div>
      <div id="vehicleFareList" class="fare-list">
        <div class="empty">차량 운임 정보가 없습니다.</div>
      </div>
    </div>

    <!-- 주변 관광 -->
    <div class="section">
      <div class="section-header">
        <div class="section-title">주변 관광</div>
        <div class="section-sub">카카오 장소 · 인기 스팟</div>
      </div>
      <div id="tourList" class="place-row"></div>
    </div>

    <!-- 주변 맛집 -->
    <div class="section">
      <div class="section-header">
        <div class="section-title">주변 맛집</div>
        <div class="section-sub">3km 이내 식당</div>
      </div>
      <div id="foodList" class="place-row"></div>
    </div>

    <!-- 주변 숙박 -->
    <div class="section">
      <div class="section-header">
        <div class="section-title">주변 숙박</div>
        <div class="section-sub">펜션 · 모텔 · 호텔</div>
      </div>
      <div id="stayList" class="place-row"></div>
    </div>
  </div>
</div>

<script>
  // ===== 설정 =====
  const API_BASE = '/ferry/api/index.php'; // 필요 시 실제 경로로 수정

  const bottomSheet = document.getElementById('bottomSheet');
  const sheetToggle = document.getElementById('sheetToggle');
  const terminalSelect = document.getElementById('terminalSelect');
  const sheetTitle = document.getElementById('sheetTitle');
  const sheetSubtitle = document.getElementById('sheetSubtitle');

  const timetableListEl = document.getElementById('timetableList');
  const chipRow = document.getElementById('chipRow');
  const terminalInfoEl = document.getElementById('terminalInfo');
  const timetableSummaryEl = document.getElementById('timetableSummary');

  const passengerFareListEl = document.getElementById('passengerFareList');
  const passengerSummaryEl = document.getElementById('passengerSummary');
  const vehicleFareListEl = document.getElementById('vehicleFareList');
  const vehicleSummaryEl = document.getElementById('vehicleSummary');

  const tourListEl = document.getElementById('tourList');
  const foodListEl = document.getElementById('foodList');
  const stayListEl = document.getElementById('stayList');

  const tabButtons = document.querySelectorAll('.tab-btn');
  const tabContents = {
    timetable: document.getElementById('tab-timetable'),
    passenger: document.getElementById('tab-passenger'),
    vehicle: document.getElementById('tab-vehicle')
  };

  function setActiveTab(tab) {
    tabButtons.forEach(btn => {
      btn.classList.toggle('active', btn.dataset.tab === tab);
    });
    Object.entries(tabContents).forEach(([key, el]) => {
      if (!el) return;
      el.style.display = key === tab ? 'block' : 'none';
    });
  }

  tabButtons.forEach(btn => {
    btn.addEventListener('click', () => setActiveTab(btn.dataset.tab));
  });

  // Bottom sheet toggle
  sheetToggle.addEventListener('click', () => {
    bottomSheet.classList.toggle('expanded');
  });

  // Kakao map
  const map = new kakao.maps.Map(document.getElementById('map'), {
    center: new kakao.maps.LatLng(34.85, 126.1), // 전남 대략
    level: 9
  });

  const markers = {};
  let terminalsCache = [];
  let currentTerminalCode = null;

  // Kakao Places 서비스
  const placesService = new kakao.maps.services.Places();

  // 내 위치
  document.getElementById('locBtn').addEventListener('click', function () {
    if (!navigator.geolocation) {
      alert('브라우저에서 현재 위치를 지원하지 않습니다.');
      return;
    }
    navigator.geolocation.getCurrentPosition(function (pos) {
      const lat = pos.coords.latitude;
      const lng = pos.coords.longitude;
      const loc = new kakao.maps.LatLng(lat, lng);
      map.panTo(loc);
      new kakao.maps.Marker({ map, position: loc });
    }, function () {
      alert('현재 위치를 가져올 수 없습니다.');
    });
  });

  // 터미널 목록 불러오기
  async function loadTerminals() {
    const url = `${API_BASE}?resource=terminals`;
    const res = await fetch(url);
    const data = await res.json();
    terminalsCache = data;

    populateTerminalSelect(data);
    data.forEach(createMarker);
  }

  function populateTerminalSelect(terminals) {
    terminals.forEach(t => {
      const opt = document.createElement('option');
      const labelCity = t.city || '';
      opt.value = t.terminal_code;
      opt.textContent = labelCity
        ? `${t.name_ko} (${labelCity})`
        : t.name_ko;
      terminalSelect.appendChild(opt);
    });
  }

  terminalSelect.addEventListener('change', function () {
    const code = this.value;
    if (!code) return;
    const t = terminalsCache.find(x => x.terminal_code === code);
    if (t) {
      focusTerminal(code, t, true);
    }
  });

  function createMarker(terminal) {
    const lat = Number(terminal.lat);
    const lng = Number(terminal.lng);
    if (!lat || !lng) return;

    const pos = new kakao.maps.LatLng(lat, lng);
    const marker = new kakao.maps.Marker({ map, position: pos });

    kakao.maps.event.addListener(marker, 'click', function () {
      focusTerminal(terminal.terminal_code, { ...terminal, lat, lng });
    });

    markers[terminal.terminal_code] = marker;
  }

  function timeToMinutes(hhmm) {
    const [h, m] = hhmm.split(':').map(Number);
    return h * 60 + m;
  }

  function getNowMinutes() {
    const now = new Date();
    return now.getHours() * 60 + now.getMinutes();
  }

  function getStatusBadgeElement(status) {
    if (!status) return '';
    const cls = 'badge badge-status-' + status.replace(/\s+/g, '');
    return `<span class="${cls}">${status}</span>`;
  }

  function renderTerminalInfo(terminal) {
    const pieces = [];
    if (terminal.city) pieces.push(terminal.city);
    if (terminal.eup_myeon) pieces.push(terminal.eup_myeon);
    const locText = pieces.join(' · ');

    let html = '';
    if (locText) {
      html += `<div style="font-size:14px; color:#4b5563; margin-bottom:4px;">${locText}</div>`;
    }

    html += `
      <div style="font-size:13px; color:#6b7280;">
        터미널 코드: ${terminal.terminal_code || '-'}
      </div>
    `;

    terminalInfoEl.innerHTML = html;
    terminalInfoEl.style.display = 'block';
  }

  function renderChips(terminal, timetables) {
    chipRow.innerHTML = '';
    const chips = [];

    if (terminal.city) {
      chips.push({ label: terminal.city });
    }
    if (terminal.eup_myeon) {
      chips.push({ label: terminal.eup_myeon });
    }
    if (timetables.length > 0) {
      const routeNames = [...new Set(timetables.map(t => t.route_name_ko).filter(Boolean))];
      routeNames.forEach(rn => chips.push({ label: rn }));
    }

    if (chips.length === 0) {
      chipRow.style.display = 'none';
      return;
    }

    chips.forEach(c => {
      const span = document.createElement('span');
      span.className = 'chip';
      span.textContent = c.label;
      chipRow.appendChild(span);
    });

    chipRow.style.display = 'flex';
  }

  function renderTimetableList(timetables, realtimeItems, nowStr) {
    const nowMin = getNowMinutes();

    const list = timetables
      .map(item => {
        const departMin = timeToMinutes(item.depart_time);
        return { ...item, departMin };
      })
      .filter(item => item.departMin >= nowMin - 5)
      .sort((a, b) => a.departMin - b.departMin)
      .slice(0, 10);

    if (list.length === 0) {
      timetableListEl.innerHTML = '<div class="empty">오늘 남은 배가 없습니다.</div>';
      timetableSummaryEl.textContent = '';
      return;
    }

    timetableSummaryEl.textContent = `${nowStr} 기준 · ${list.length}편 남음`;

    const html = list.map(item => {
      const rt = realtimeItems.find(r => r.departure_time === item.depart_time);
      const status = rt ? rt.status : null;
      const badge = getStatusBadgeElement(status);
      const weekday = item.weekday_type && item.weekday_type !== '매일'
        ? ` (${item.weekday_type})`
        : '';

      const notes = item.notes
        ? `<div class="notes">${item.notes}</div>`
        : '';

      return `
        <div class="timetable-item">
          <div class="timetable-top">
            <div>
              <div class="time-main">${item.depart_time} → ${item.arrive_time}</div>
              <div class="time-sub">${item.arrive_place || ''}${weekday}</div>
            </div>
            ${badge}
          </div>
          ${notes}
        </div>
      `;
    }).join('');

    timetableListEl.innerHTML = html;
  }

  function renderPassengerFareList(fares, routeName) {
    if (!fares || fares.length === 0) {
      passengerFareListEl.innerHTML = '<div class="empty">승객 요금 정보가 없습니다.</div>';
      passengerSummaryEl.textContent = routeName || '';
      return;
    }

    passengerSummaryEl.textContent = routeName || '';

    const html = fares.map(f => {
      const titleParts = [];
      if (f.passenger_type) titleParts.push(f.passenger_type);
      if (f.resident_type) titleParts.push(f.resident_type);
      if (f.discount_type) titleParts.push(f.discount_type);
      const title = titleParts.join(' · ') || '승객';

      const amountBase = f.total_oneway ?? f.fare_oneway;
      const amount = amountBase ? Number(amountBase).toLocaleString('ko-KR') + '원' : '-';

      const subParts = [];
      if (f.age_group) subParts.push(f.age_group);
      if (f.fuel_surcharge) subParts.push('유류 ' + Number(f.fuel_surcharge).toLocaleString('ko-KR') + '원');
      if (f.port_fee) subParts.push('항만료 ' + Number(f.port_fee).toLocaleString('ko-KR') + '원');
      if (f.notes) subParts.push(f.notes);
      const sub = subParts.join(' · ');

      return `
        <div class="fare-row">
          <div class="fare-main">
            <div class="fare-title">${title}</div>
            ${sub ? `<div class="fare-sub">${sub}</div>` : ''}
          </div>
          <div class="fare-amount">${amount}</div>
        </div>
      `;
    }).join('');

    passengerFareListEl.innerHTML = html;
  }

  function renderVehicleFareList(fares, routeName) {
    if (!fares || fares.length === 0) {
      vehicleFareListEl.innerHTML = '<div class="empty">차량 운임 정보가 없습니다.</div>';
      vehicleSummaryEl.textContent = routeName || '';
      return;
    }

    vehicleSummaryEl.textContent = routeName || '';

    const html = fares.map(f => {
      const titleParts = [];
      if (f.vehicle_type) titleParts.push(f.vehicle_type);
      if (f.vehicle_subtype) titleParts.push(f.vehicle_subtype);
      const title = titleParts.join(' · ') || '차량';

      const amountBase = f.fare_oneway;
      const amount = amountBase ? Number(amountBase).toLocaleString('ko-KR') + '원' : '-';

      const subParts = [];
      if (f.tonnage) subParts.push(Number(f.tonnage) + '톤');
      if (f.length_m) subParts.push(Number(f.length_m) + 'm');
      if (f.notes) subParts.push(f.notes);
      const sub = subParts.join(' · ');

      return `
        <div class="fare-row">
          <div class="fare-main">
            <div class="fare-title">${title}</div>
            ${sub ? `<div class="fare-sub">${sub}</div>` : ''}
          </div>
          <div class="fare-amount">${amount}</div>
        </div>
      `;
    }).join('');

    vehicleFareListEl.innerHTML = html;
  }

  function clearNearbyPlaces() {
    tourListEl.innerHTML = '<div class="empty">좌표 정보가 없습니다.</div>';
    foodListEl.innerHTML = '<div class="empty">좌표 정보가 없습니다.</div>';
    stayListEl.innerHTML = '<div class="empty">좌표 정보가 없습니다.</div>';
  }

  function searchNearbyPlaces(lat, lng) {
    const center = new kakao.maps.LatLng(lat, lng);
    const options = {
      location: center,
      radius: 3000,
      sort: kakao.maps.services.SortBy.DISTANCE
    };

    categorySearch('AT4', options, tourListEl, '#관광지');
    categorySearch('FD6', options, foodListEl, '#맛집');
    categorySearch('AD5', options, stayListEl, '#숙박');
  }

  function categorySearch(categoryCode, options, targetEl, tagLabel) {
    targetEl.innerHTML = '<div class="empty">주변 정보를 불러오는 중입니다...</div>';

    placesService.categorySearch(categoryCode, (data, status) => {
      console.log('[Places]', categoryCode, 'status=', status, 'count=', data ? data.length : 0);

      if (status !== kakao.maps.services.Status.OK || !data || data.length === 0) {
        targetEl.innerHTML = '<div class="empty">주변에 표시할 장소가 없습니다.</div>';
        return;
      }

      targetEl.innerHTML = '';
      const items = data.slice(0, 10);

      items.forEach(place => {
        const card = document.createElement('div');
        card.className = 'place-card';

        const distMeters = place.distance ? parseInt(place.distance, 10) : null;
        let distText = '';
        if (distMeters !== null && !isNaN(distMeters)) {
          distText = distMeters >= 1000
            ? (distMeters / 1000).toFixed(1) + 'km'
            : distMeters + 'm';
        }

        const addr = place.road_address_name || place.address_name || '';

        card.innerHTML = `
          <div class="place-thumb"></div>
          <div class="place-name">${place.place_name}</div>
          <div class="place-meta">
            ${addr ? addr : ''}${addr && distText ? ' · ' : ''}${distText || ''}
          </div>
          <div class="place-tag">${tagLabel}</div>
        `;

        card.addEventListener('click', () => {
          if (place.place_url) {
            window.open(place.place_url, '_blank');
          }
        });

        targetEl.appendChild(card);
      });
    }, options);
  }

  // ===== 터미널 포커스 =====
  async function focusTerminal(code, terminal, fromSelect = false) {
    currentTerminalCode = code;

    const lat = Number(terminal.lat);
    const lng = Number(terminal.lng);

    if (lat && lng) {
      const pos = new kakao.maps.LatLng(lat, lng);
      map.panTo(pos);
    }

    if (!fromSelect) {
      terminalSelect.value = code;
    }

    const now = new Date();
    const nowStr = now.toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit' });

    sheetTitle.textContent = terminal.name_ko;
    sheetSubtitle.textContent = `${nowStr} 기준 정보`;
    bottomSheet.classList.add('expanded');

    const dateStr = now.toISOString().slice(0, 10);

    // 초기 상태 문구
    timetableListEl.innerHTML = '<div class="empty">시간표를 불러오는 중입니다...</div>';
    passengerFareListEl.innerHTML = '<div class="empty">승객 요금을 불러오는 중입니다...</div>';
    vehicleFareListEl.innerHTML = '<div class="empty">차량 운임을 불러오는 중입니다...</div>';
    timetableSummaryEl.textContent = '';
    passengerSummaryEl.textContent = '';
    vehicleSummaryEl.textContent = '';

    let timetables = [];
    let realtimeItems = [];
    let passengerFares = [];
    let vehicleFares = [];
    let mainRouteName = '';
    let mainRouteCode = null;

    try {
      const [ttRes, rtRes] = await Promise.all([
        fetch(`${API_BASE}?resource=timetables&terminal=${encodeURIComponent(code)}&date=${dateStr}`),
        fetch(`${API_BASE}?resource=realtime&terminal=${encodeURIComponent(code)}`)
      ]);

      if (ttRes.ok) {
        const ttData = await ttRes.json();
        if (ttData && Array.isArray(ttData.timetables)) {
          timetables = ttData.timetables;
          if (timetables.length > 0) {
            mainRouteCode = timetables[0].route_code || null;
            mainRouteName = timetables[0].route_name_ko || '';
          }
        }
      } else {
        console.error('timetables API 오류:', ttRes.status);
      }

      if (rtRes.ok) {
        const rtData = await rtRes.json();
        if (rtData && Array.isArray(rtData.items)) {
          realtimeItems = rtData.items;
        }
      } else {
        console.error('realtime API 오류:', rtRes.status);
      }

      // 승객/차량 운임 가져오기 (대표 route 기준)
      if (mainRouteCode) {
        try {
          const pfRes = await fetch(`${API_BASE}?resource=passenger_fare&route=${encodeURIComponent(mainRouteCode)}`);
          if (pfRes.ok) {
            const pfData = await pfRes.json();
            passengerFares = Array.isArray(pfData.items) ? pfData.items :
                             Array.isArray(pfData) ? pfData : [];
          }
        } catch (e) {
          console.error('passenger_fare API 오류:', e);
        }

        try {
          const vfRes = await fetch(`${API_BASE}?resource=vehicle_fare&route=${encodeURIComponent(mainRouteCode)}`);
          if (vfRes.ok) {
            const vfData = await vfRes.json();
            vehicleFares = Array.isArray(vfData.items) ? vfData.items :
                           Array.isArray(vfData) ? vfData : [];
          }
        } catch (e) {
          console.error('vehicle_fare API 오류:', e);
        }
      }
    } catch (e) {
      console.error('timetables/realtime 로딩 중 에러:', e);
    }

    renderChips(terminal, timetables);
    renderTerminalInfo(terminal);
    renderTimetableList(timetables, realtimeItems, nowStr);

    if (mainRouteCode) {
      renderPassengerFareList(passengerFares, mainRouteName);
      renderVehicleFareList(vehicleFares, mainRouteName);
    } else {
      renderPassengerFareList([], '');
      renderVehicleFareList([], '');
    }

    if (lat && lng) {
      searchNearbyPlaces(lat, lng);
    } else {
      clearNearbyPlaces();
    }

    // 기본 탭은 시간표
    setActiveTab('timetable');
  }

  // 초기 로딩
  loadTerminals().catch(err => {
    console.error(err);
    alert('터미널 목록을 불러오지 못했습니다.');
  });
</script>
</body>
</html>
