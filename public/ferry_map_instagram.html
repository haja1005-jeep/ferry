<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8">
  <title>전남 여객선 지도 (Instagram Style)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">

  <style>
    :root {
      --sheet-bg: #ffffff;
      --accent: #22c55e;
      --text-muted: #6b7280;
      --border-subtle: #e5e7eb;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, "Apple SD Gothic Neo", system-ui, sans-serif;
      background: #f3f4f6;
      overscroll-behavior: none;
    }

    /* ===== 헤더 (상단바) ===== */
    header {
      position: fixed;
      top: 0; left: 0; right: 0;
      z-index: 20;
      background: #ffffffee;
      backdrop-filter: blur(12px);
      padding: 8px 10px;
      display: flex;
      align-items: center;
      gap: 6px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.06);
    }

    header strong {
      font-size: 16px;
      font-weight: 700;
      white-space: nowrap;
    }

    header select,
    header button {
      padding: 8px 10px;
      border-radius: 12px;
      font-size: 13px;
      font-weight: 600;
      border: none;
      background: #f7f7f7;
      box-shadow: 0 2px 4px rgba(0,0,0,0.06);
      min-height: 34px;
      cursor: pointer;
      white-space: nowrap;
    }

    header select:focus,
    header button:active {
      outline: none;
      background: #efefef;
      box-shadow: 0 3px 8px rgba(0,0,0,0.12);
    }

    #map {
      position: absolute;
      top: 48px; /* header height */
      left: 0;
      right: 0;
      bottom: 0;
    }

    /* ===== Sidebar (검색 패널) ===== */
    .sidebar {
      position: fixed;
      top: 48px;
      left: 0;
      bottom: 0;
      width: 260px;
      max-width: 80%;
      background: #ffffff;
      box-shadow: 2px 0 12px rgba(0,0,0,0.1);
      z-index: 25;
      transform: translateX(-100%);
      transition: transform 0.2s ease-out;
      display: flex;
      flex-direction: column;
      padding: 10px 12px;
      font-size: 13px;
    }

    .sidebar.open {
      transform: translateX(0);
    }

    .sidebar h2 {
      font-size: 15px;
      margin: 0 0 8px;
    }

    .sidebar label {
      display: block;
      margin-top: 6px;
      margin-bottom: 2px;
      font-weight: 600;
    }

    .sidebar select,
    .sidebar input {
      width: 100%;
      padding: 7px 8px;
      border-radius: 8px;
      border: 1px solid #e5e7eb;
      font-size: 13px;
    }

    .sidebar button {
      width: 100%;
      margin-top: 8px;
      padding: 8px 10px;
      border-radius: 10px;
      border: none;
      background: #111827;
      color: #ffffff;
      font-weight: 600;
      cursor: pointer;
    }

    .sidebar-result {
      margin-top: 10px;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
    }

    .sidebar-result-item {
      padding: 6px 4px;
      border-bottom: 1px solid #f3f4f6;
    }

    .sidebar-result-item strong {
      display: block;
      font-size: 13px;
    }

    .sidebar-result-item span {
      font-size: 12px;
      color: #6b7280;
    }

    /* ===== Bottom Sheet ===== */
    .bottom-sheet {
      position: fixed;
      left: 0;
      right: 0;
      bottom: 0;
      z-index: 30;
      background: var(--sheet-bg);
      border-radius: 22px 22px 0 0;
      box-shadow: 0 -6px 20px rgba(0,0,0,0.08);
      transform: translateY(70%);
      transition: transform 0.25s ease-out;
      max-height: 80vh;
      display: flex;
      flex-direction: column;
    }

    .bottom-sheet.expanded {
      transform: translateY(0);
    }

    .sheet-handle {
      width: 100%;
      padding-top: 8px;
      padding-bottom: 6px;
      display: flex;
      justify-content: center;
      align-items: center;
      cursor: pointer;
    }

    .sheet-handle-bar {
      width: 48px;
      height: 6px;
      border-radius: 999px;
      background: #d4d4d4;
    }

    .sheet-header {
      padding: 4px 18px 10px 18px;
      border-bottom: 1px solid var(--border-subtle);
    }

    .sheet-title {
      font-size: 17px;
      font-weight: 700;
    }

    .sheet-subtitle {
      font-size: 13px;
      color: #737373;
      margin-top: 4px;
    }

    .sheet-content {
      padding: 10px 18px 14px 18px;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
    }

    /* ===== 칩(Chip) ===== */
    .chip-row {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-bottom: 10px;
    }

    .chip {
      font-size: 13px;
      padding: 6px 12px;
      border-radius: 20px;
      background: #f3f3f3;
      border: none;
      font-weight: 600;
      color: #4b5563;
    }

    /* ===== 섹션 공통 ===== */
    .section {
      margin-bottom: 20px;
    }

    .section-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 8px;
    }

    .section-title {
      font-size: 15px;
      font-weight: 700;
    }

    .section-sub {
      font-size: 12px;
      color: #9ca3af;
    }

    .empty {
      font-size: 13px;
      color: var(--text-muted);
      padding: 8px 0;
    }

    /* ===== 터미널 기본 정보 ===== */
    #terminalInfo {
      font-size: 13px;
      color: #4b5563;
    }

    /* ===== 시간표 카드 ===== */
    .timetable-item {
      background: #ffffff;
      border-radius: 16px;
      padding: 10px 12px;
      margin-bottom: 8px;
      box-shadow: 0 3px 8px rgba(0,0,0,0.05);
      font-size: 14px;
    }

    .timetable-top {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 6px;
    }

    .time-main {
      font-size: 15px;
      font-weight: 700;
    }

    .time-sub {
      font-size: 12px;
      color: #6b7280;
    }

    .notes {
      font-size: 12px;
      color: var(--text-muted);
      margin-top: 4px;
    }

    .badge {
      display: inline-block;
      padding: 3px 8px;
      border-radius: 999px;
      font-size: 12px;
      border: 1px solid #d4d4d8;
      color: #4b5563;
      background: #f9fafb;
      white-space: nowrap;
    }

    .badge-status-출항 {
      border-color: #22c55e;
      color: #16a34a;
      background: #ecfdf3;
    }

    .badge-status-결항 {
      border-color: #ef4444;
      color: #b91c1c;
      background: #fef2f2;
    }

    .badge-status-지연 {
      border-color: #f97316;
      color: #c2410c;
      background: #fff7ed;
    }

    .badge-status-대기 {
      border-color: #3b82f6;
      color: #1d4ed8;
      background: #eff6ff;
    }

    /* ===== 탭 바 ===== */
    .tab-bar {
      display: flex;
      gap: 6px;
      padding: 4px;
      border-radius: 999px;
      background: #f3f4f6;
      margin-bottom: 10px;
      margin-top: 4px;
    }

    .tab-btn {
      flex: 1;
      border: none;
      border-radius: 999px;
      padding: 6px 0;
      font-size: 13px;
      font-weight: 600;
      background: transparent;
      color: #6b7280;
      cursor: pointer;
    }

    .tab-btn.active {
      background: #111827;
      color: #ffffff;
      box-shadow: 0 2px 6px rgba(0,0,0,0.15);
    }

    .tab-content {
      display: block;
    }

    /* ===== 운임표 리스트 ===== */
    .fare-list {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .fare-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
      background: #ffffff;
      border-radius: 14px;
      padding: 8px 10px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.04);
      font-size: 13px;
    }

    .fare-main {
      flex: 1;
    }

    .fare-title {
      font-weight: 600;
    }

    .fare-sub {
      font-size: 12px;
      color: #6b7280;
      margin-top: 2px;
    }

    .fare-amount {
      font-weight: 700;
      white-space: nowrap;
    }

    /* ===== 주변 장소 카드 ===== */
    .place-row {
      display: flex;
      gap: 10px;
      overflow-x: auto;
      padding-bottom: 4px;
      -webkit-overflow-scrolling: touch;
    }

    .place-card {
      flex: 0 0 150px;
      background: #ffffff;
      border-radius: 16px;
      padding: 8px;
      border: none;
      box-shadow: 0 4px 10px rgba(0,0,0,0.06);
      cursor: pointer;
      display: flex;
      flex-direction: column;
      gap: 4px;
      transition: transform 0.15s ease, box-shadow 0.15s ease;
    }

    .place-card:hover {
      transform: translateY(-3px);
      box-shadow: 0 6px 14px rgba(0,0,0,0.1);
    }

    .place-thumb {
      width: 100%;
      height: 80px;
      border-radius: 14px;
      background: linear-gradient(135deg, #e2e2e2, #efefef);
      position: relative;
      overflow: hidden;
    }

    .place-thumb::after {
      content: "PHOTO";
      position: absolute;
      bottom: 4px;
      right: 6px;
      font-size: 10px;
      color: rgba(255,255,255,0.9);
      padding: 2px 6px;
      border-radius: 999px;
      background: rgba(0,0,0,0.35);
    }

    .place-name {
      font-size: 13px;
      font-weight: 700;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .place-meta {
      font-size: 11px;
      color: var(--text-muted);
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .place-tag {
      font-size: 10px;
      display: inline-block;
      padding: 2px 6px;
      border-radius: 999px;
      border: 1px solid #e5e7eb;
      color: #4b5563;
      background: #ffffff;
      margin-top: 2px;
    }

    @media (min-width: 768px) {
      .bottom-sheet {
        left: 50%;
        transform: translate(50%, 60%);
        max-width: 420px;
        border-radius: 22px;
      }
      .bottom-sheet.expanded {
        transform: translate(50%, 0);
      }
    }

    /* 모바일 폰트 강화 */
    @media (max-width: 480px) {
      header strong { font-size: 17px; }
      header select,
      header button {
        font-size: 14px;
        padding: 9px 10px;
      }
      .sheet-title { font-size: 17px; }
      .sheet-subtitle { font-size: 13px; }
    }


	/* 떠 있는 햄버거 버튼 (사이드바 토글) */
.hamburger-btn {
  position: fixed;
  left: 10px;
  top: 7px;          /* 헤더 아래쪽에 살짝 걸치게 */
  z-index: 26;
  width: 38px;
  height: 38px;
  border-radius: 999px;
  border: none;
  background: #ffffffee;
  box-shadow: 0 3px 8px rgba(0,0,0,0.18);
  font-size: 20px;
  font-weight: 700;
  line-height: 1;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;

}

.hamburger-btn:active {
  transform: scale(0.96);
  box-shadow: 0 2px 6px rgba(0,0,0,0.2);
}

  </style>

  <script src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=257fdd3647dd6abdb05eae8681106514&libraries=services"></script>
</head>
<body>
<header>
  <button id="hamburgerBtn" class="hamburger-btn">☰</button>
  <strong>전남 여객선</strong>
  <select id="regionSelect">
    <option value="">전체</option>
  </select>
  <select id="terminalSelect">
    <option value="">터미널</option>
  </select>
  <button id="locBtn">내 위치</button>
  <button id="searchToggleBtn">검색</button>
</header>


<div id="map"></div>

<!-- 검색 사이드바 -->
<div id="sidebar" class="sidebar">
  <h2>항로 검색</h2>
  <label for="searchFrom">출발 터미널</label>
  <select id="searchFrom">
    <option value="">선택</option>
  </select>

  <label for="searchTo">도착지 (도서명/행선지)</label>
  <input type="text" id="searchTo" placeholder="예: 비금, 신의도">

  <label for="searchDate">날짜</label>
  <input type="date" id="searchDate">

  <button id="searchBtn">검색하기</button>

  <div class="sidebar-result" id="searchResult"></div>
</div>

<!-- Bottom Sheet -->
<div id="bottomSheet" class="bottom-sheet">
  <div class="sheet-handle" id="sheetToggle">
    <div class="sheet-handle-bar"></div>
  </div>
  <div class="sheet-header">
    <div class="sheet-title" id="sheetTitle">터미널을 선택하세요</div>
    <div class="sheet-subtitle" id="sheetSubtitle">지도에서 핀을 누르거나 상단에서 선택하세요.</div>
  </div>
  <div class="sheet-content">
    <div class="chip-row" id="chipRow" style="display:none;"></div>
    <div class="section" id="terminalInfo" style="display:none;"></div>

    <div class="tab-bar">
      <button class="tab-btn active" data-tab="timetable">시간표</button>
      <button class="tab-btn" data-tab="passenger">승객요금</button>
      <button class="tab-btn" data-tab="vehicle">차량운임</button>
    </div>

    <!-- 시간표 탭 -->
    <div class="section tab-content" id="tab-timetable">
      <div class="section-header">
        <div class="section-title">오늘 시간표 & 실시간 운항</div>
        <div class="section-sub" id="timetableSummary"></div>
      </div>
      <div id="timetableList" class="timetable-list">
        <div class="empty">표시할 운항 정보가 없습니다.</div>
      </div>
    </div>

    <!-- 승객 요금 탭 -->
    <div class="section tab-content" id="tab-passenger" style="display:none;">
      <div class="section-header">
        <div class="section-title">승객 요금</div>
        <div class="section-sub" id="passengerSummary"></div>
      </div>
      <div id="passengerFareList" class="fare-list">
        <div class="empty">승객 요금 정보가 없습니다.</div>
      </div>
    </div>

    <!-- 차량 운임 탭 -->
    <div class="section tab-content" id="tab-vehicle" style="display:none;">
      <div class="section-header">
        <div class="section-title">차량 운임</div>
        <div class="section-sub" id="vehicleSummary"></div>
      </div>
      <div id="vehicleFareList" class="fare-list">
        <div class="empty">차량 운임 정보가 없습니다.</div>
      </div>
    </div>

    <!-- 주변 관광 -->
    <div class="section">
      <div class="section-header">
        <div class="section-title">주변 관광</div>
        <div class="section-sub">카카오 장소 · 인기 스팟</div>
      </div>
      <div id="tourList" class="place-row"></div>
    </div>

    <!-- 주변 맛집 -->
    <div class="section">
      <div class="section-header">
        <div class="section-title">주변 맛집</div>
        <div class="section-sub">3km 이내 식당</div>
      </div>
      <div id="foodList" class="place-row"></div>
    </div>

    <!-- 주변 숙박 -->
    <div class="section">
      <div class="section-header">
        <div class="section-title">주변 숙박</div>
        <div class="section-sub">펜션 · 모텔 · 호텔</div>
      </div>
      <div id="stayList" class="place-row"></div>
    </div>
  </div>
</div>

<script>
  const API_BASE = '/ferry/api/index.php';

  const bottomSheet = document.getElementById('bottomSheet');
  const sheetToggle = document.getElementById('sheetToggle');
  const terminalSelect = document.getElementById('terminalSelect');
  const regionSelect = document.getElementById('regionSelect');
  const sheetTitle = document.getElementById('sheetTitle');
  const sheetSubtitle = document.getElementById('sheetSubtitle');
  const timetableListEl = document.getElementById('timetableList');
  const chipRow = document.getElementById('chipRow');
  const terminalInfoEl = document.getElementById('terminalInfo');
  const timetableSummaryEl = document.getElementById('timetableSummary');
  const passengerFareListEl = document.getElementById('passengerFareList');
  const passengerSummaryEl = document.getElementById('passengerSummary');
  const vehicleFareListEl = document.getElementById('vehicleFareList');
  const vehicleSummaryEl = document.getElementById('vehicleSummary');
  const tourListEl = document.getElementById('tourList');
  const foodListEl = document.getElementById('foodList');
  const stayListEl = document.getElementById('stayList');

  const sidebar = document.getElementById('sidebar');
  const searchToggleBtn = document.getElementById('searchToggleBtn');
  const searchFrom = document.getElementById('searchFrom');
  const searchTo = document.getElementById('searchTo');
  const searchDate = document.getElementById('searchDate');
  const searchBtn = document.getElementById('searchBtn');
  const searchResult = document.getElementById('searchResult');

  const tabButtons = document.querySelectorAll('.tab-btn');
  const tabContents = {
    timetable: document.getElementById('tab-timetable'),
    passenger: document.getElementById('tab-passenger'),
    vehicle: document.getElementById('tab-vehicle')
  };

  function setActiveTab(tab) {
    tabButtons.forEach(btn => {
      btn.classList.toggle('active', btn.dataset.tab === tab);
    });
    Object.entries(tabContents).forEach(([key, el]) => {
      if (!el) return;
      el.style.display = key === tab ? 'block' : 'none';
    });
  }

  tabButtons.forEach(btn => {
    btn.addEventListener('click', () => setActiveTab(btn.dataset.tab));
  });

  sheetToggle.addEventListener('click', () => {
    bottomSheet.classList.toggle('expanded');
  });

  // Kakao map
  const map = new kakao.maps.Map(document.getElementById('map'), {
    center: new kakao.maps.LatLng(34.85, 126.1),
    level: 9
  });

  // 마커 이미지: 기본(회색) + 선택(빨간 별)
  const normalMarkerImage = null; // 카카오 기본 마커
  const selectedMarkerImage = new kakao.maps.MarkerImage(
    'https://t1.daumcdn.net/localimg/localimages/07/mapapidoc/markerStar.png',
    new kakao.maps.Size(24, 35)
  );

  const markers = {};     // terminal_code -> marker
  let selectedMarker = null;
  let terminalsCache = [];
  let currentTerminalCode = null;

  const placesService = new kakao.maps.services.Places();

  document.getElementById('locBtn').addEventListener('click', function () {
    if (!navigator.geolocation) {
      alert('브라우저에서 현재 위치를 지원하지 않습니다.');
      return;
    }
    navigator.geolocation.getCurrentPosition(function (pos) {
      const lat = pos.coords.latitude;
      const lng = pos.coords.longitude;
      const loc = new kakao.maps.LatLng(lat, lng);
      map.panTo(loc);
      new kakao.maps.Marker({ map, position: loc });
    }, function () {
      alert('현재 위치를 가져올 수 없습니다.');
    });
  });

  // ===== 터미널 목록 =====
  async function loadTerminals() {
    const url = `${API_BASE}?resource=terminals`;
    const res = await fetch(url);
    const data = await res.json();
    terminalsCache = data;

    populateRegionSelect(data);
    populateTerminalSelect(data);
    populateSearchFrom(data);
    data.forEach(createMarker);
  }

  function populateRegionSelect(terminals) {
    const set = new Set();
    terminals.forEach(t => {
      if (t.city) set.add(t.city);
    });
    [...set].sort().forEach(city => {
      const opt = document.createElement('option');
      opt.value = city;
      opt.textContent = city;
      regionSelect.appendChild(opt);
    });
  }

  function populateTerminalSelect(terminals, regionFilter = '') {
    terminalSelect.innerHTML = '<option value="">터미널</option>';
    terminals
      .filter(t => !regionFilter || t.city === regionFilter)
      .forEach(t => {
        const opt = document.createElement('option');
        const labelCity = t.city || '';
        opt.value = t.terminal_code;
        opt.textContent = labelCity
          ? `${t.name_ko} (${labelCity})`
          : t.name_ko;
        terminalSelect.appendChild(opt);
      });
  }

  function populateSearchFrom(terminals) {
    searchFrom.innerHTML = '<option value="">선택</option>';
    terminals.forEach(t => {
      const opt = document.createElement('option');
      opt.value = t.terminal_code;
      opt.textContent = t.name_ko;
      searchFrom.appendChild(opt);
    });
  }

  regionSelect.addEventListener('change', function () {
    const region = this.value;
    populateTerminalSelect(terminalsCache, region);

    // 마커 show/hide
    terminalsCache.forEach(t => {
      const m = markers[t.terminal_code];
      if (!m) return;
      if (!region || t.city === region) {
        m.setMap(map);
      } else {
        m.setMap(null);
      }
    });

    // 현재 선택된 터미널이 필터 밖이면 선택 해제
    const current = terminalsCache.find(t => t.terminal_code === currentTerminalCode);
    if (current && region && current.city !== region) {
      if (selectedMarker) selectedMarker.setImage(normalMarkerImage);
      selectedMarker = null;
      currentTerminalCode = null;
      terminalSelect.value = '';
      sheetTitle.textContent = '터미널을 선택하세요';
      sheetSubtitle.textContent = '지도에서 핀을 누르거나 상단에서 선택하세요.';
      timetableListEl.innerHTML = '<div class="empty">표시할 운항 정보가 없습니다.</div>';
      passengerFareListEl.innerHTML = '<div class="empty">승객 요금 정보가 없습니다.</div>';
      vehicleFareListEl.innerHTML = '<div class="empty">차량 운임 정보가 없습니다.</div>';
      chipRow.style.display = 'none';
      terminalInfoEl.style.display = 'none';
    }
  });

  terminalSelect.addEventListener('change', function () {
    const code = this.value;
    if (!code) return;
    const t = terminalsCache.find(x => x.terminal_code === code);
    if (t) {
      focusTerminal(code, t, true);
    }
  });

  function createMarker(terminal) {
    const lat = Number(terminal.lat);
    const lng = Number(terminal.lng);
    if (!lat || !lng) return;

    const pos = new kakao.maps.LatLng(lat, lng);
    const marker = new kakao.maps.Marker({ map, position: pos });

    kakao.maps.event.addListener(marker, 'click', function () {
      focusTerminal(terminal.terminal_code, { ...terminal, lat, lng });
    });

    markers[terminal.terminal_code] = marker;
  }

  function timeToMinutes(hhmm) {
    const [h, m] = hhmm.split(':').map(Number);
    return h * 60 + m;
  }

  function getNowMinutes() {
    const now = new Date();
    return now.getHours() * 60 + now.getMinutes();
  }

  function getStatusBadgeElement(status) {
    if (!status) return '';
    const cls = 'badge badge-status-' + status.replace(/\s+/g, '');
    return `<span class="${cls}">${status}</span>`;
  }

  function renderTerminalInfo(terminal) {
    const pieces = [];
    if (terminal.city) pieces.push(terminal.city);
    if (terminal.eup_myeon) pieces.push(terminal.eup_myeon);
    const locText = pieces.join(' · ');

    let html = '';
    if (locText) {
      html += `<div style="margin-bottom:4px;">${locText}</div>`;
    }
    html += `<div style="font-size:12px; color:#6b7280;">터미널 코드: ${terminal.terminal_code || '-'}</div>`;

    terminalInfoEl.innerHTML = html;
    terminalInfoEl.style.display = 'block';
  }

  function renderChips(terminal, timetables) {
    chipRow.innerHTML = '';
    const chips = [];

    if (terminal.city) chips.push({ label: terminal.city });
    if (terminal.eup_myeon) chips.push({ label: terminal.eup_myeon });
    if (timetables.length > 0) {
      const routeNames = [...new Set(timetables.map(t => t.route_name_ko).filter(Boolean))];
      routeNames.forEach(rn => chips.push({ label: rn }));
    }

    if (chips.length === 0) {
      chipRow.style.display = 'none';
      return;
    }

    chips.forEach(c => {
      const span = document.createElement('span');
      span.className = 'chip';
      span.textContent = c.label;
      chipRow.appendChild(span);
    });

    chipRow.style.display = 'flex';
  }

  function renderTimetableList(timetables, realtimeItems, nowStr) {
    const nowMin = getNowMinutes();

    const list = timetables
      .map(item => {
        const departMin = timeToMinutes(item.depart_time);
        return { ...item, departMin };
      })
      .filter(item => item.departMin >= nowMin - 5)
      .sort((a, b) => a.departMin - b.departMin)
      .slice(0, 10);

    if (list.length === 0) {
      timetableListEl.innerHTML = '<div class="empty">오늘 남은 배가 없습니다.</div>';
      timetableSummaryEl.textContent = '';
      return;
    }

    timetableSummaryEl.textContent = `${nowStr} 기준 · ${list.length}편 남음`;

    const html = list.map(item => {
      const rt = realtimeItems.find(r => r.departure_time === item.depart_time);
      const status = rt ? rt.status : null;
      const badge = getStatusBadgeElement(status);
      const weekday = item.weekday_type && item.weekday_type !== '매일'
        ? ` (${item.weekday_type})`
        : '';

      const notes = item.notes
        ? `<div class="notes">${item.notes}</div>`
        : '';

      return `
        <div class="timetable-item">
          <div class="timetable-top">
            <div>
              <div class="time-main">${item.depart_time} → ${item.arrive_time}</div>
              <div class="time-sub">${item.arrive_place || ''}${weekday}</div>
            </div>
            ${badge}
          </div>
          ${notes}
        </div>
      `;
    }).join('');

    timetableListEl.innerHTML = html;
  }

  function renderPassengerFareList(fares, routeName) {
    if (!fares || fares.length === 0) {
      passengerFareListEl.innerHTML = '<div class="empty">승객 요금 정보가 없습니다.</div>';
      passengerSummaryEl.textContent = routeName || '';
      return;
    }

    passengerSummaryEl.textContent = routeName || '';

    const html = fares.map(f => {
      const titleParts = [];
      if (f.passenger_type) titleParts.push(f.passenger_type);
      if (f.resident_type) titleParts.push(f.resident_type);
      if (f.discount_type) titleParts.push(f.discount_type);
      const title = titleParts.join(' · ') || '승객';

      const amountBase = f.total_oneway ?? f.fare_oneway;
      const amount = amountBase ? Number(amountBase).toLocaleString('ko-KR') + '원' : '-';

      const subParts = [];
      if (f.age_group) subParts.push(f.age_group);
      if (f.fuel_surcharge) subParts.push('유류 ' + Number(f.fuel_surcharge).toLocaleString('ko-KR') + '원');
      if (f.port_fee) subParts.push('항만료 ' + Number(f.port_fee).toLocaleString('ko-KR') + '원');
      if (f.notes) subParts.push(f.notes);
      const sub = subParts.join(' · ');

      return `
        <div class="fare-row">
          <div class="fare-main">
            <div class="fare-title">${title}</div>
            ${sub ? `<div class="fare-sub">${sub}</div>` : ''}
          </div>
          <div class="fare-amount">${amount}</div>
        </div>
      `;
    }).join('');

    passengerFareListEl.innerHTML = html;
  }

  function renderVehicleFareList(fares, routeName) {
    if (!fares || fares.length === 0) {
      vehicleFareListEl.innerHTML = '<div class="empty">차량 운임 정보가 없습니다.</div>';
      vehicleSummaryEl.textContent = routeName || '';
      return;
    }

    vehicleSummaryEl.textContent = routeName || '';

    const html = fares.map(f => {
      const titleParts = [];
      if (f.vehicle_type) titleParts.push(f.vehicle_type);
      if (f.vehicle_subtype) titleParts.push(f.vehicle_subtype);
      const title = titleParts.join(' · ') || '차량';

      const amountBase = f.fare_oneway;
      const amount = amountBase ? Number(amountBase).toLocaleString('ko-KR') + '원' : '-';

      const subParts = [];
      if (f.tonnage) subParts.push(Number(f.tonnage) + '톤');
      if (f.length_m) subParts.push(Number(f.length_m) + 'm');
      if (f.notes) subParts.push(f.notes);
      const sub = subParts.join(' · ');

      return `
        <div class="fare-row">
          <div class="fare-main">
            <div class="fare-title">${title}</div>
            ${sub ? `<div class="fare-sub">${sub}</div>` : ''}
          </div>
          <div class="fare-amount">${amount}</div>
        </div>
      `;
    }).join('');

    vehicleFareListEl.innerHTML = html;
  }

  function clearNearbyPlaces() {
    tourListEl.innerHTML = '<div class="empty">좌표 정보가 없습니다.</div>';
    foodListEl.innerHTML = '<div class="empty">좌표 정보가 없습니다.</div>';
    stayListEl.innerHTML = '<div class="empty">좌표 정보가 없습니다.</div>';
  }

  function searchNearbyPlaces(lat, lng) {
    const center = new kakao.maps.LatLng(lat, lng);
    const options = {
      location: center,
      radius: 3000,
      sort: kakao.maps.services.SortBy.DISTANCE
    };

    categorySearch('AT4', options, tourListEl, '#관광지');
    categorySearch('FD6', options, foodListEl, '#맛집');
    categorySearch('AD5', options, stayListEl, '#숙박');
  }

  function categorySearch(categoryCode, options, targetEl, tagLabel) {
    targetEl.innerHTML = '<div class="empty">주변 정보를 불러오는 중입니다...</div>';

    placesService.categorySearch(categoryCode, (data, status) => {
      if (status !== kakao.maps.services.Status.OK || !data || data.length === 0) {
        targetEl.innerHTML = '<div class="empty">주변에 표시할 장소가 없습니다.</div>';
        return;
      }

      targetEl.innerHTML = '';
      const items = data.slice(0, 10);

      items.forEach(place => {
        const card = document.createElement('div');
        card.className = 'place-card';

        const distMeters = place.distance ? parseInt(place.distance, 10) : null;
        let distText = '';
        if (distMeters !== null && !isNaN(distMeters)) {
          distText = distMeters >= 1000
            ? (distMeters / 1000).toFixed(1) + 'km'
            : distMeters + 'm';
        }

        const addr = place.road_address_name || place.address_name || '';

        card.innerHTML = `
          <div class="place-thumb"></div>
          <div class="place-name">${place.place_name}</div>
          <div class="place-meta">
            ${addr ? addr : ''}${addr && distText ? ' · ' : ''}${distText || ''}
          </div>
          <div class="place-tag">${tagLabel}</div>
        `;

        card.addEventListener('click', () => {
          if (place.place_url) {
            window.open(place.place_url, '_blank');
          }
        });

        targetEl.appendChild(card);
      });
    }, options);
  }

  // ===== 터미널 포커스 & 마커 색 변경 =====
  async function focusTerminal(code, terminal, fromSelect = false) {
    currentTerminalCode = code;

    // 마커 색상 처리
    if (selectedMarker) {
      selectedMarker.setImage(normalMarkerImage);
    }
    const marker = markers[code];
    if (marker) {
      marker.setImage(selectedMarkerImage);
      selectedMarker = marker;
      const lat = Number(terminal.lat);
      const lng = Number(terminal.lng);
      if (lat && lng) {
        const pos = new kakao.maps.LatLng(lat, lng);
        map.panTo(pos);
      }
    }

    if (!fromSelect) {
      terminalSelect.value = code;
    }

    const now = new Date();
    const nowStr = now.toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit' });
    const dateStr = now.toISOString().slice(0, 10);

    sheetTitle.textContent = terminal.name_ko;
    sheetSubtitle.textContent = `${nowStr} 기준 정보`;
    bottomSheet.classList.add('expanded');

    timetableListEl.innerHTML = '<div class="empty">시간표를 불러오는 중입니다...</div>';
    passengerFareListEl.innerHTML = '<div class="empty">승객 요금을 불러오는 중입니다...</div>';
    vehicleFareListEl.innerHTML = '<div class="empty">차량 운임을 불러오는 중입니다...</div>';
    timetableSummaryEl.textContent = '';
    passengerSummaryEl.textContent = '';
    vehicleSummaryEl.textContent = '';

    let timetables = [];
    let realtimeItems = [];
    let passengerFares = [];
    let vehicleFares = [];
    let mainRouteName = '';
    let mainRouteCode = null;

    try {
      const [ttRes, rtRes] = await Promise.all([
        fetch(`${API_BASE}?resource=timetables&terminal=${encodeURIComponent(code)}&date=${dateStr}`),
        fetch(`${API_BASE}?resource=realtime&terminal=${encodeURIComponent(code)}`)
      ]);

      if (ttRes.ok) {
        const ttData = await ttRes.json();
        if (ttData && Array.isArray(ttData.timetables)) {
          timetables = ttData.timetables;
          if (timetables.length > 0) {
            mainRouteCode = timetables[0].route_code || null;
            mainRouteName = timetables[0].route_name_ko || '';
          }
        }
      }

      if (rtRes.ok) {
        const rtData = await rtRes.json();
        if (rtData && Array.isArray(rtData.items)) {
          realtimeItems = rtData.items;
        }
      }

      if (mainRouteCode) {
        try {
          const pfRes = await fetch(`${API_BASE}?resource=passenger_fare&route=${encodeURIComponent(mainRouteCode)}`);
          if (pfRes.ok) {
            const pfData = await pfRes.json();
            passengerFares = Array.isArray(pfData.items) ? pfData.items :
                             Array.isArray(pfData) ? pfData : [];
          }
        } catch (e) { console.error(e); }

        try {
          const vfRes = await fetch(`${API_BASE}?resource=vehicle_fare&route=${encodeURIComponent(mainRouteCode)}`);
          if (vfRes.ok) {
            const vfData = await vfRes.json();
            vehicleFares = Array.isArray(vfData.items) ? vfData.items :
                           Array.isArray(vfData) ? vfData : [];
          }
        } catch (e) { console.error(e); }
      }
    } catch (e) {
      console.error('timetables/realtime 로딩 중 에러:', e);
    }

    renderChips(terminal, timetables);
    renderTerminalInfo(terminal);
    renderTimetableList(timetables, realtimeItems, nowStr);

    if (mainRouteCode) {
      renderPassengerFareList(passengerFares, mainRouteName);
      renderVehicleFareList(vehicleFares, mainRouteName);
    } else {
      renderPassengerFareList([], '');
      renderVehicleFareList([], '');
    }

    const lat = Number(terminal.lat);
    const lng = Number(terminal.lng);
    if (lat && lng) {
      searchNearbyPlaces(lat, lng);
    } else {
      clearNearbyPlaces();
    }

    setActiveTab('timetable');
  }


  const hamburgerBtn = document.getElementById('hamburgerBtn');

  // ===== 사이드바: 출발/도착/날짜 검색 =====
  searchToggleBtn.addEventListener('click', () => {
    sidebar.classList.toggle('open');
  });

  // 햄버거 버튼으로도 사이드바 열기/닫기
   hamburgerBtn.addEventListener('click', () => {
    sidebar.classList.toggle('open');
   });

  searchBtn.addEventListener('click', async () => {
    const fromCode = searchFrom.value;
    const toKeyword = searchTo.value.trim();
    const dateVal = searchDate.value || new Date().toISOString().slice(0, 10);

    if (!fromCode) {
      alert('출발 터미널을 선택해 주세요.');
      return;
    }

    searchResult.innerHTML = '<div class="empty">검색 중...</div>';

    try {
      const res = await fetch(`${API_BASE}?resource=timetables&terminal=${encodeURIComponent(fromCode)}&date=${dateVal}`);
      if (!res.ok) throw new Error(res.status);
      const data = await res.json();
      const list = Array.isArray(data.timetables) ? data.timetables : [];

      let filtered = list;
      if (toKeyword) {
        const kw = toKeyword.replace(/\s+/g, '').toLowerCase();
        filtered = list.filter(item =>
          (item.arrive_place || '').replace(/\s+/g, '').toLowerCase().includes(kw)
        );
      }

      if (filtered.length === 0) {
        searchResult.innerHTML = '<div class="empty">조건에 맞는 운항편이 없습니다.</div>';
        return;
      }

      const html = filtered.map(item => `
        <div class="sidebar-result-item">
          <strong>${item.depart_time} → ${item.arrive_time}</strong>
          <span>${item.arrive_place || ''} · 편명 ${item.trip_no || '-'}</span>
        </div>
      `).join('');

      searchResult.innerHTML = html;
    } catch (e) {
      console.error(e);
      searchResult.innerHTML = '<div class="empty">검색 중 오류가 발생했습니다.</div>';
    }
  });

  // 초기 로딩
  loadTerminals().catch(err => {
    console.error(err);
    alert('터미널 목록을 불러오지 못했습니다.');
  });
</script>
</body>
</html>
