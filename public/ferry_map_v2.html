<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8">
  <title>전남 여객선 지도 (인스타 지도 스타일)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">

  <style>
    :root {
      --sheet-bg: #ffffff;
      --accent: #22c55e;
      --text-muted: #6b7280;
      --border-subtle: #e5e7eb;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Apple SD Gothic Neo", sans-serif;
      background: #f3f4f6;
      overscroll-behavior: none;
    }

    header {
      position: fixed;
      top: 0; left: 0; right: 0;
      z-index: 20;
      background: #ffffffee;
      backdrop-filter: blur(10px);
      padding: 8px 12px;
      display: flex;
      align-items: center;
      gap: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.06);
    }

    header strong {
      font-size: 15px;
    }

    header select, header button {
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid #e5e7eb;
      font-size: 13px;
      background: #fff;
    }

    header button {
      cursor: pointer;
      white-space: nowrap;
    }

    #map {
      position: absolute;
      top: 44px;
      left: 0;
      right: 0;
      bottom: 0;
    }

    /* bottom sheet */
    .bottom-sheet {
      position: fixed;
      left: 0;
      right: 0;
      bottom: 0;
      z-index: 30;
      background: var(--sheet-bg);
      border-radius: 16px 16px 0 0;
      box-shadow: 0 -4px 10px rgba(0,0,0,0.08);
      transform: translateY(70%);
      transition: transform 0.25s ease-out;
      max-height: 80vh;
      display: flex;
      flex-direction: column;
    }

    .bottom-sheet.expanded {
      transform: translateY(0);
    }

    .sheet-handle {
      width: 100%;
      padding-top: 6px;
      padding-bottom: 4px;
      display: flex;
      justify-content: center;
      align-items: center;
      cursor: pointer;
    }

    .sheet-handle-bar {
      width: 40px;
      height: 4px;
      border-radius: 999px;
      background: #d1d5db;
    }

    .sheet-header {
      padding: 4px 16px 8px 16px;
      border-bottom: 1px solid var(--border-subtle);
    }

    .sheet-title {
      font-size: 15px;
      font-weight: 600;
    }

    .sheet-subtitle {
      font-size: 12px;
      color: var(--text-muted);
      margin-top: 2px;
    }

    .sheet-content {
      padding: 8px 16px 10px 16px;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
    }

    /* 터미널 태그 / 칩 */
    .chip-row {
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
      margin-bottom: 8px;
    }

    .chip {
      font-size: 11px;
      padding: 2px 6px;
      border-radius: 999px;
      border: 1px solid #e5e7eb;
      color: #4b5563;
      background: #f9fafb;
    }

    /* 섹션 공통 */
    .section {
      margin-bottom: 10px;
    }

    .section-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 4px;
    }

    .section-title {
      font-size: 13px;
      font-weight: 600;
    }

    .section-sub {
      font-size: 11px;
      color: var(--text-muted);
    }

    /* 시간표 리스트 */
    .timetable-item {
      padding: 6px 0;
      border-bottom: 1px solid #f3f4f6;
      font-size: 13px;
    }

    .timetable-top {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 6px;
    }

    .time-main {
      font-weight: 600;
    }

    .time-sub {
      font-size: 11px;
      color: var(--text-muted);
    }

    .badge {
      display: inline-block;
      padding: 1px 6px;
      border-radius: 999px;
      font-size: 11px;
      border: 1px solid #d4d4d8;
      color: #4b5563;
      background: #f9fafb;
      white-space: nowrap;
    }

    .badge-status-출항 {
      border-color: #22c55e;
      color: #16a34a;
      background: #ecfdf3;
    }

    .badge-status-결항 {
      border-color: #ef4444;
      color: #b91c1c;
      background: #fef2f2;
    }

    .badge-status-지연 {
      border-color: #f97316;
      color: #c2410c;
      background: #fff7ed;
    }

    .badge-status-대기 {
      border-color: #3b82f6;
      color: #1d4ed8;
      background: #eff6ff;
    }

    .notes {
      font-size: 11px;
      color: var(--text-muted);
      margin-top: 2px;
    }

    .empty {
      font-size: 13px;
      color: var(--text-muted);
      padding: 8px 0;
    }

    /* 인스타 스타일 주변 장소 카드 */
    .place-row {
      display: flex;
      gap: 8px;
      overflow-x: auto;
      padding-bottom: 4px;
      -webkit-overflow-scrolling: touch;
    }

    .place-card {
      flex: 0 0 140px;
      background: #f9fafb;
      border-radius: 12px;
      padding: 6px;
      border: 1px solid #e5e7eb;
      cursor: pointer;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .place-thumb {
      width: 100%;
      height: 84px;
      border-radius: 10px;
      background: linear-gradient(135deg, #e5e7eb, #f3f4f6);
      position: relative;
      overflow: hidden;
    }

    .place-thumb::after {
      content: "PHOTO";
      position: absolute;
      bottom: 4px;
      right: 6px;
      font-size: 10px;
      color: rgba(255,255,255,0.8);
      padding: 2px 4px;
      border-radius: 999px;
      background: rgba(0,0,0,0.35);
    }

    .place-name {
      font-size: 12px;
      font-weight: 600;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .place-meta {
      font-size: 11px;
      color: var(--text-muted);
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .place-tag {
      font-size: 10px;
      display: inline-block;
      padding: 1px 5px;
      border-radius: 999px;
      border: 1px solid #e5e7eb;
      color: #4b5563;
      background: #ffffff;
      margin-top: 2px;
    }

    @media (min-width: 768px) {
      .bottom-sheet {
        left: 50%;
        transform: translate(50%, 60%);
        max-width: 420px;
        border-radius: 16px;
      }
      .bottom-sheet.expanded {
        transform: translate(50%, 0);
      }
    }
  </style>

  <!-- Kakao 지도 + Places 라이브러리 -->
  <script src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=257fdd3647dd6abdb05eae8681106514&libraries=services"></script>
</head>
<body>
<header>
  <strong>전남 여객선</strong>
  <select id="terminalSelect">
    <option value="">터미널 선택</option>
    <!-- JS에서 동적 채움 -->
  </select>
  <button id="locBtn">내 위치</button>
</header>

<div id="map"></div>

<!-- Bottom Sheet -->
<div id="bottomSheet" class="bottom-sheet">
  <div class="sheet-handle" id="sheetToggle">
    <div class="sheet-handle-bar"></div>
  </div>
  <div class="sheet-header">
    <div class="sheet-title" id="sheetTitle">터미널을 선택하세요</div>
    <div class="sheet-subtitle" id="sheetSubtitle">지도에서 핀을 누르거나 상단 셀렉트 박스를 선택하세요.</div>
  </div>
  <div class="sheet-content">
    <!-- 터미널 태그 / 기본 정보 -->
    <div class="chip-row" id="chipRow" style="display:none;"></div>
    <div class="section" id="terminalInfo" style="display:none;"></div>

    <!-- 오늘 시간표 + 실시간 운항 -->
    <div class="section">
      <div class="section-header">
        <div class="section-title">오늘 시간표 & 실시간 운항</div>
        <div class="section-sub" id="timetableSummary"></div>
      </div>
      <div id="timetableList" class="timetable-list">
        <div class="empty">표시할 운항 정보가 없습니다.</div>
      </div>
    </div>

    <!-- 주변 관광 -->
    <div class="section">
      <div class="section-header">
        <div class="section-title">주변 관광</div>
        <div class="section-sub">카카오 장소 · 인기 스팟</div>
      </div>
      <div id="tourList" class="place-row">
        <!-- 동적 채움 -->
      </div>
    </div>

    <!-- 주변 맛집 -->
    <div class="section">
      <div class="section-header">
        <div class="section-title">주변 맛집</div>
        <div class="section-sub">3km 이내 식당</div>
      </div>
      <div id="foodList" class="place-row">
        <!-- 동적 채움 -->
      </div>
    </div>

    <!-- 주변 숙박 -->
    <div class="section">
      <div class="section-header">
        <div class="section-title">주변 숙박</div>
        <div class="section-sub">펜션 · 모텔 · 호텔</div>
      </div>
      <div id="stayList" class="place-row">
        <!-- 동적 채움 -->
      </div>
    </div>
  </div>
</div>

<script>
  // === 설정  제미나이 코드 ===
  const API_BASE = '/ferry/api/index.php'; // 필요시 실제 경로로 수정

  // bottom sheet toggle
  const bottomSheet = document.getElementById('bottomSheet');
  const sheetToggle = document.getElementById('sheetToggle');
  sheetToggle.addEventListener('click', () => {
    bottomSheet.classList.toggle('expanded');
  });

  const terminalSelect = document.getElementById('terminalSelect');
  const sheetTitle = document.getElementById('sheetTitle');
  const sheetSubtitle = document.getElementById('sheetSubtitle');
  const timetableListEl = document.getElementById('timetableList');
  const chipRow = document.getElementById('chipRow');
  const terminalInfoEl = document.getElementById('terminalInfo');
  const timetableSummaryEl = document.getElementById('timetableSummary');

  const tourListEl = document.getElementById('tourList');
  const foodListEl = document.getElementById('foodList');
  const stayListEl = document.getElementById('stayList');

  // Kakao map init
  const map = new kakao.maps.Map(document.getElementById('map'), {
    center: new kakao.maps.LatLng(34.85, 126.1), // 전남 대략 위치
    level: 9
  });

  const markers = {};
  let currentTerminalCode = null;
  let terminalsCache = [];

  // Kakao Places 서비스
  const placesService = new kakao.maps.services.Places();

  // ◀◀◀ [수정 1] 주변 장소 마커들을 저장할 배열
  let placeMarkers = [];

  // ◀◀◀ [수정 1] 지도에 표시된 장소 마커들을 지우는 함수
  function clearPlaceMarkers() {
    for (let i = 0; i < placeMarkers.length; i++) {
      placeMarkers[i].setMap(null);
    }
    placeMarkers = [];
  }

  function createMarker(terminal) {
    if (!terminal.lat || !terminal.lng) return; // 좌표 없는 건 스킵
    const pos = new kakao.maps.LatLng(terminal.lat, terminal.lng);
    const marker = new kakao.maps.Marker({ map, position: pos });

    kakao.maps.event.addListener(marker, 'click', function () {
      focusTerminal(terminal.terminal_code, terminal);
    });

    markers[terminal.terminal_code] = marker;
  }

  function populateTerminalSelect(terminals) {
    terminals.forEach(t => {
      const opt = document.createElement('option');
      opt.value = t.terminal_code;
      opt.textContent = `${t.name_ko} (${t.city || '전남'})`;
      terminalSelect.appendChild(opt);
    });
  }

  terminalSelect.addEventListener('change', function () {
    const code = this.value;
    if (!code) return;
    const t = terminalsCache.find(x => x.terminal_code === code);
    if (t) {
      focusTerminal(code, t, true);
    }
  });

  // 내 위치 버튼
  document.getElementById('locBtn').addEventListener('click', function () {
    if (!navigator.geolocation) {
      alert('브라우저에서 현재 위치를 지원하지 않습니다.');
      return;
    }
    navigator.geolocation.getCurrentPosition(function (pos) {
      const lat = pos.coords.latitude;
      const lng = pos.coords.longitude;
      const loc = new kakao.maps.LatLng(lat, lng);
      map.panTo(loc);
      new kakao.maps.Marker({ map, position: loc });
    }, function () {
      alert('현재 위치를 가져올 수 없습니다.');
    });
  });

  // 전남 전체 터미널 목록 불러오기
  async function loadTerminals() {
    // region 필터가 필요하면 &region=전남권 등으로 수정
    const url = `${API_BASE}?resource=terminals`;
    const res = await fetch(url);
    const data = await res.json();
    terminalsCache = data;

    populateTerminalSelect(data);
    data.forEach(createMarker);
  }

  // HH:MM → 분
  function timeToMinutes(hhmm) {
    const [h, m] = hhmm.split(':').map(Number);
    return h * 60 + m;
  }

  function getNowMinutes() {
    const now = new Date();
    return now.getHours() * 60 + now.getMinutes();
  }

  function getStatusBadgeElement(status) {
    if (!status) return '';
    const cls = 'badge badge-status-' + status.replace(/\s+/g, '');
    return `<span class="${cls}">${status}</span>`;
  }

  function renderTerminalInfo(terminal) {
    const pieces = [];
    if (terminal.city) pieces.push(terminal.city);
    if (terminal.eup_myeon) pieces.push(terminal.eup_myeon);
    const locText = pieces.join(' · ');

    let html = '';
    if (locText) {
      html += `<div class="section-sub" style="margin-bottom:4px;">${locText}</div>`;
    }

    // 터미널 코드 같은 기본 정보
    html += `
      <div style="font-size:11px; color:${getComputedStyle(document.body).getPropertyValue('--text-muted') || '#6b7280'};">
        터미널 코드: ${terminal.terminal_code || '-'}
      </div>
    `;

    terminalInfoEl.innerHTML = html;
    terminalInfoEl.style.display = 'block';
  }

  // 특정 터미널 포커스 + 바텀시트 업데이트
  async function focusTerminal(code, terminal, fromSelect = false) {
    currentTerminalCode = code;

    // 지도 이동
    if (terminal.lat && terminal.lng) {
      const pos = new kakao.maps.LatLng(terminal.lat, terminal.lng);
      map.panTo(pos);
    }

    // 상단 셀렉트 동기화
    if (!fromSelect) {
      terminalSelect.value = code;
    }

    // bottom sheet 제목
    sheetTitle.textContent = terminal.name_ko;
    const now = new Date();
    const nowStr = now.toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit' });
    sheetSubtitle.textContent = `${nowStr} 기준 정보`;

    bottomSheet.classList.add('expanded');

    // 
    // ⬇⬇⬇ ◀◀◀ [수정 2] API 호출 로직 (Promise.allSettled로 변경) ⬇⬇⬇
    //
    const dateStr = now.toISOString().slice(0, 10); // YYYY-MM-DD
    
    try {
      // Promise.all 대신 allSettled 사용 (하나가 실패해도 나머지는 처리)
      const results = await Promise.allSettled([
        fetch(`${API_BASE}?resource=timetables&terminal=${encodeURIComponent(code)}&date=${dateStr}`),
        fetch(`${API_BASE}?resource=realtime&terminal=${encodeURIComponent(code)}`)
      ]);

      const [ttResult, rtResult] = results;

      let timetables = [];
      let realtimeItems = [];

      // 시간표(timetables) API 결과 처리
      if (ttResult.status === 'fulfilled' && ttResult.value.ok) {
        // 성공 + HTTP 상태 OK
        const ttData = await ttResult.value.json();
        timetables = ttData.timetables || [];
      } else if (ttResult.status === 'fulfilled' && !ttResult.value.ok) {
        // API 서버가 404, 500 등 에러 응답
        console.error('시간표 API 응답 오류:', ttResult.value.status, ttResult.value.statusText);
      } else if (ttResult.status === 'rejected') {
        // 네트워크 자체 실패 (CORS, DNS 등)
        console.error('시간표 API 호출 실패:', ttResult.reason);
      }

      // 실시간(realtime) API 결과 처리
      if (rtResult.status === 'fulfilled' && rtResult.value.ok) {
        const rtData = await rtResult.value.json();
        realtimeItems = rtData.items || [];
      } else if (rtResult.status === 'fulfilled' && !rtResult.value.ok) {
        console.error('실시간 API 응답 오류:', rtResult.value.status, rtResult.value.statusText);
      } else if (rtResult.status === 'rejected') {
        console.error('실시간 API 호출 실패:', rtResult.reason);
      }

      // 렌더링 함수 호출
      renderChips(terminal, timetables);
      renderTerminalInfo(terminal);
      renderTimetableList(timetables, realtimeItems, nowStr);

    } catch (error) {
      console.error('API 처리 중 예기치 못한 오류:', error);
      timetableListEl.innerHTML = '<div class="empty">정보를 불러오는 데 실패했습니다.</div>';
    }
    //
    // ⬆⬆⬆ ◀◀◀ [수정 2] API 호출 로직 끝 ⬆⬆⬆
    //

    // 주변 관광/맛집/숙박 검색
    if (terminal.lat && terminal.lng) {
      clearPlaceMarkers(); // ◀◀◀ [수정 1] 새 검색 전, 기존 장소 마커 지우기
      searchNearbyPlaces(terminal.lat, terminal.lng);
    } else {
      clearNearbyPlaces();
      clearPlaceMarkers(); // ◀◀◀ [수정 1] 좌표가 없을 때도 지워줍니다.
    }
  }

  function renderChips(terminal, timetables) {
    chipRow.innerHTML = '';
    const chips = [];

    if (terminal.city) {
      chips.push({ label: terminal.city, type: 'city' });
    }
    if (terminal.eup_myeon) {
      chips.push({ label: terminal.eup_myeon, type: 'emd' });
    }
    if (timetables.length > 0) {
      const routeNames = [...new Set(timetables.map(t => t.route_name_ko).filter(Boolean))];
      routeNames.forEach(rn => chips.push({ label: rn, type: 'route' }));
    }

    if (chips.length === 0) {
      chipRow.style.display = 'none';
      return;
    }

    chips.forEach(c => {
      const span = document.createElement('span');
      span.className = 'chip';
      span.textContent = c.label;
      chipRow.appendChild(span);
    });

    chipRow.style.display = 'flex';
  }

  function renderTimetableList(timetables, realtimeItems, nowStr) {
    const nowMin = getNowMinutes();

    const list = timetables
      .map(item => {
        const departMin = timeToMinutes(item.depart_time);
        return { ...item, departMin };
      })
      .filter(item => item.departMin >= nowMin - 5) // 출발 후 5분 지난 건 숨김
      .sort((a, b) => a.departMin - b.departMin)
      .slice(0, 10);

    if (list.length === 0) {
      timetableListEl.innerHTML = '<div class="empty">오늘 남은 배가 없습니다.</div>';
      timetableSummaryEl.textContent = '';
      return;
    }

    timetableSummaryEl.textContent = `${nowStr} 기준 · ${list.length}편 남음`;

    const html = list.map(item => {
      const rt = realtimeItems.find(r => r.departure_time === item.depart_time);
      const status = rt ? rt.status : null;
      const badge = getStatusBadgeElement(status);
      const weekday = item.weekday_type && item.weekday_type !== '매일'
        ? ` (${item.weekday_type})`
        : '';

      const notes = item.notes
        ? `<div class="notes">${item.notes}</div>`
        : '';

      return `
        <div class="timetable-item">
          <div class="timetable-top">
            <div>
              <div class="time-main">${item.depart_time} → ${item.arrive_time}</div>
              <div class="time-sub">${item.arrive_place || ''}${weekday}</div>
            </div>
            ${badge}
          </div>
          ${notes}
        </div>
      `;
    }).join('');

    timetableListEl.innerHTML = html;
  }

  // 주변 장소 검색 (카카오 카테고리 검색)
  function clearNearbyPlaces() {
    tourListEl.innerHTML = '<div class="empty">좌표 정보가 없습니다.</div>';
    foodListEl.innerHTML = '<div class="empty">좌표 정보가 없습니다.</div>';
    stayListEl.innerHTML = '<div class="empty">좌표 정보가 없습니다.</div>';
  }

  function searchNearbyPlaces(lat, lng) {
    const center = new kakao.maps.LatLng(lat, lng);
    const options = {
      location: center,
      radius: 3000 // 3km
    };

    // 관광명소 AT4, 음식점 FD6, 숙박 AD5
    categorySearch('AT4', options, tourListEl, '#관광지');
    categorySearch('FD6', options, foodListEl, '#맛집');
    categorySearch('AD5', options, stayListEl, '#숙박');
  }

  function categorySearch(categoryCode, options, targetEl, tagLabel) {
    targetEl.innerHTML = '<div class="empty">주변 정보를 불러오는 중입니다...</div>';

    placesService.categorySearch(categoryCode, (data, status) => {
      if (status !== kakao.maps.services.Status.OK || !data || data.length === 0) {
        targetEl.innerHTML = '<div class="empty">주변에 표시할 장소가 없습니다.</div>';
        return;
      }

      targetEl.innerHTML = '';
      const items = data.slice(0, 10); // 최대 10개

      items.forEach(place => {
        const card = document.createElement('div');
        card.className = 'place-card';

        const distMeters = place.distance ? parseInt(place.distance, 10) : null;
        let distText = '';
        if (distMeters !== null && !isNaN(distMeters)) {
          distText = distMeters >= 1000
            ? (distMeters / 1000).toFixed(1) + 'km'
            : distMeters + 'm';
        }

        const addr = place.road_address_name || place.address_name || '';

        card.innerHTML = `
          <div class="place-thumb"></div>
          <div class="place-name">${place.place_name}</div>
          <div class="place-meta">
            ${addr ? addr : ''}${addr && distText ? ' · ' : ''}${distText || ''}
          </div>
          <div class="place-tag">${tagLabel}</div>
        `;
        
        // 
        // ⬇⬇⬇ ◀◀◀ [수정 1] 지도에 마커 생성 및 추가 ⬇⬇⬇
        //
        const placePosition = new kakao.maps.LatLng(place.y, place.x);
        const marker = new kakao.maps.Marker({
          position: placePosition,
          map: map // 마커를 지도에 표시
        });

        // 생성된 마커를 배열에 추가하여 나중에 지울 수 있도록 관리
        placeMarkers.push(marker);
        //
        // ⬆⬆⬆ ◀◀◀ [수정 1] 마커 생성 코드 끝 ⬆⬆⬆
        //

        card.addEventListener('click', () => {
          if (place.place_url) {
            window.open(place.place_url, '_blank');
          }
        });

        targetEl.appendChild(card);
      });
    }, options);
  }

  // 초기 로딩
  loadTerminals().catch(err => {
    console.error(err);
    alert('터미널 목록을 불러오지 못했습니다.');
  });
</script>
</body>
</html>
